<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ğŸ’¬ ì´ìš© í›„ê¸°</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    .review-card {
      background-color: #ffffff;
      border: 1px solid #e3e3e3;
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 15px;
      box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    .review-card:hover {
      background-color: #f9f9f9;
    }
    .review-actions {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .review-text {
      white-space: pre-wrap;
      word-break: break-word;
    }
  </style>
</head>
<body class="bg-light">
  <div class="container mt-5">
    <h3 class="mb-4 text-primary">ğŸ’¬ ì´ìš© í›„ê¸°</h3>

    <!-- ì •ë ¬ ì˜µì…˜ -->
    <div class="mb-4 d-flex justify-content-between align-items-center">
      <div>
        <label for="sortSelect" class="form-label">ì •ë ¬ ê¸°ì¤€:</label>
        <select id="sortSelect" class="form-select" style="width: 200px;" onchange="sortReviews(this.value)">
          <option value="latest" {% if sort == 'latest' %}selected{% endif %}>ìµœì‹ ìˆœ</option>
          <option value="popular" {% if sort == 'popular' %}selected{% endif %}>ì¸ê¸°ìˆœ</option>
        </select>
      </div>
    </div>

    <!-- í›„ê¸° ì‘ì„± (ë¡œê·¸ì¸ëœ ì‚¬ìš©ìë§Œ ê°€ëŠ¥) -->
    {% if user %}
    <form method="POST" class="mt-4 mb-4">
      <div class="mb-3">
        <label for="reviewText" class="form-label">í›„ê¸° ì‘ì„±</label>
        <textarea name="review" class="form-control" rows="3" placeholder="í›„ê¸°ë¥¼ ì‘ì„±í•˜ì„¸ìš”..." required></textarea>
      </div>
      <button type="submit" class="btn btn-primary">ğŸ“© í›„ê¸° ë“±ë¡</button>
    </form>
    {% else %}
    <p class="text-muted mt-4">ë¡œê·¸ì¸ í›„ í›„ê¸°ë¥¼ ì‘ì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
    {% endif %}

<!-- í›„ê¸° ëª©ë¡ -->
<div id="review-list">
  {% for review in reviews %}
    <div class="review-card mb-3 p-3">
      <div class="d-flex justify-content-between">
        <div>
          <h5 class="mb-1">{{ review['nickname'] }}</h5>
          <small class="text-muted">{{ review['created_at'] }}</small>
        </div>
        <div class="review-actions">
          â¤ï¸ <span class="badge bg-danger">{{ review['likes'] }}</span>
          <form action="/like_review/{{ review['id'] }}" method="POST" class="d-inline">
            <button type="submit" class="btn btn-sm btn-outline-danger">ì¢‹ì•„ìš”</button>
          </form>
        </div>
      </div>

      <p class="review-text mt-2" id="review-text-{{ review['id'] }}">{{ review['review'] }}</p>

      {% if user and user['id'] == review['user_id'] %}
      <div class="mt-2">
        <button class="btn btn-sm btn-outline-primary" onclick="enableEdit({{ review['id'] }}, '{{ review['review'] }}')">âœï¸ ìˆ˜ì •</button>
        <button class="btn btn-sm btn-outline-danger" onclick="confirmDelete({{ review['id'] }})">ğŸ—‘ï¸ ì‚­ì œ</button>
      </div>
      {% endif %}
    </div>
  {% else %}
    <p class="text-muted text-center">ë“±ë¡ëœ í›„ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
  {% endfor %}
</div>


  <!-- ì‚­ì œ í™•ì¸ ëª¨ë‹¬ -->
  <div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">ğŸ—‘ï¸ í›„ê¸° ì‚­ì œ</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          ì •ë§ë¡œ ì´ í›„ê¸°ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ì·¨ì†Œ</button>
          <button type="button" class="btn btn-danger" id="confirmDeleteBtn">ì‚­ì œ</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    function sortReviews(order) {
      window.location.href = "/review?sort=" + order;
    }

    let deleteReviewId = null;
    
    function confirmDelete(reviewId) {
      deleteReviewId = reviewId;
      const deleteModal = new bootstrap.Modal(document.getElementById('deleteModal'));
      deleteModal.show();
    }

    document.getElementById("confirmDeleteBtn").addEventListener("click", function() {
      if (deleteReviewId) {
        fetch(`/delete_review/${deleteReviewId}`, {
          method: "POST"
        }).then(response => {
          if (response.ok) {
            window.location.reload();
          } else {
            alert("ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
          }
        });
      }
    });

   function enableEdit(reviewId, currentText) {
   const reviewText = document.getElementById(`review-text-${reviewId}`);

    if (!reviewText) {
      console.error(`âŒ ë¦¬ë·° í…ìŠ¤íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. reviewId: ${reviewId}`);
      alert("ë¦¬ë·°ë¥¼ ìˆ˜ì •í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. í˜ì´ì§€ë¥¼ ë‹¤ì‹œ ë¡œë“œí•´ë³´ì„¸ìš”.");
      return;
    }

      // ì›ë˜ í…ìŠ¤íŠ¸ ë°±ì—…
      const originalText = reviewText.textContent;

      // ìˆ˜ì • ì…ë ¥ í¼ìœ¼ë¡œ ë³€ê²½
      reviewText.innerHTML = `
        <textarea id="edit-text-${reviewId}" class="form-control mb-2" rows="3">${currentText}</textarea>
        <div class="mt-2">
          <button class="btn btn-sm btn-success" onclick="submitEdit(${reviewId})">âœ… ì €ì¥</button>
          <button class="btn btn-sm btn-secondary" onclick="cancelEdit(${reviewId}, '${originalText}')">âŒ ì·¨ì†Œ</button>
        </div>
      `;
    }

    function cancelEdit(reviewId, originalText) {
      const reviewText = document.getElementById(`review-text-${reviewId}`);
      if (reviewText) {
        reviewText.textContent = originalText;
      } else {
        console.error(`âŒ ë¦¬ë·° í…ìŠ¤íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. reviewId: ${reviewId}`);
      }
    }

    function submitEdit(reviewId) {
      const newText = document.getElementById(`edit-text-${reviewId}`).value.trim();

      if (newText === "") {
        alert("í›„ê¸° ë‚´ìš©ì€ ë¹„ì–´ ìˆì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
        return;
      }

      fetch(`/edit_review/${reviewId}`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ review: newText })
      })
      .then(response => {
        if (!response.ok) {
          throw new Error(`ì„œë²„ ì˜¤ë¥˜: ${response.status} - ${response.statusText}`);
        }
        return response.json();
      })
      .then(data => {
        if (data.success) {
          const reviewText = document.getElementById(`review-text-${reviewId}`);
          reviewText.textContent = newText;
          alert("í›„ê¸°ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.");
        } else {
          alert("í›„ê¸° ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: " + data.message);
        }
      })
      .catch(error => {
        console.error("âŒ Error:", error);
        alert("í›„ê¸° ìˆ˜ì • ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ì„œë²„ ì˜¤ë¥˜ë¥¼ í™•ì¸í•˜ì„¸ìš”.");
      });
    }

  </script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
