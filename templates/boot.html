<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ë‹¤ë‚šì•„ ë‚šì‹œ ì˜ˆì•½ ë„ìš°ë¯¸</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      background-color: #f4f7fc;
    }
    .navbar {
      background: #0d6efd;
    }
    .navbar-brand img {
      width: 50px;
    }
    .card {
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
    }
    .card-header {
      background: #007bff;
      color: #fff;
      font-weight: bold;
      border-top-left-radius: 10px;
      border-top-right-radius: 10px;
    }
    .btn-custom {
      background-color: #0d6efd;
      color: #fff;
      border: none;
    }
    .btn-custom:hover {
      background-color: #0b5ed7;
    }
  </style>
</head>
<body>

 <!-- ìƒë‹¨ ë„¤ë¹„ê²Œì´ì…˜ -->
<nav class="navbar navbar-expand-lg navbar-dark px-4">
  <a href="/" class="navbar-brand d-flex align-items-center">
    <img src="{{ url_for('static', filename='nuiqulb.png') }}" alt="ë¡œê³ ">
    <span class="fs-4 ms-2">ë‹¤ë‚šì•„ ë‚šì‹œ ì˜ˆì•½ ë„ìš°ë¯¸</span>
  </a>
  <div class="ms-auto d-flex align-items-center">
    {% if session.user %}
      <span class="text-white me-3">ğŸ‘‹ {{ session.user.nickname }} ë‹˜</span>
      <a href="/mypage" class="btn btn-light btn-sm me-2">ğŸ‘¤ ë§ˆì´í˜ì´ì§€</a>
      <a href="/logout" class="btn btn-outline-light btn-sm">ğŸšª ë¡œê·¸ì•„ì›ƒ</a>
    {% else %}
      <a href="/login" class="btn btn-light btn-sm me-2">ğŸ” ë¡œê·¸ì¸</a>
      <a href="/register" class="btn btn-outline-light btn-sm">ğŸ“ íšŒì›ê°€ì…</a>
    {% endif %}
  </div>
</nav>

  <!-- ë³¸ë¬¸ -->
  <div class="container mt-4">
    <div class="row">
      <!-- ì¢Œì¸¡ ì‚¬ì´ë“œë°” -->
      <div class="col-md-3 mb-3">
        <div class="card p-3">
          <h5 class="text-primary mb-3">ğŸŒ¤ ê¸°ìƒ ì •ë³´</h5>
          <a href="https://www.weather.go.kr/" target="_blank" class="btn btn-warning w-100 mb-2">ê¸°ìƒì²­ ë°”ë¡œê°€ê¸°</a>
          <h5 class="text-primary mt-4 mb-2">ğŸ£ ì˜ˆì•½ ê²€ìƒ‰</h5>
          <input type="date" id="dateInput" class="form-control mb-2">
          <button onclick="fetchReservations()" class="btn btn-custom w-100">ğŸ” ì˜ˆì•½ ê²€ìƒ‰</button>
        </div>
      </div>

      <!-- ì¤‘ì•™ ì˜ˆì•½ ê²°ê³¼ ì˜ì—­ -->
      <div class="col-md-6">
        <div id="resultArea" class="card p-4">
          <h2 class="mb-3">ğŸ£ ì „êµ­ ì„ ìƒ ë‚šì‹œ ì˜ˆì•½ ì •ë³´</h2>
          <p class="text-muted">ë‚ ì§œë¥¼ ì„ íƒí•˜ê³  ì¢Œì¸¡ì—ì„œ "ì˜ˆì•½ ê²€ìƒ‰"ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.</p>
        </div>
      </div>

      <!-- ìš°ì¸¡ ì‚¬ì´ë“œë°” (ì´ìš© í›„ê¸°) -->
      <div class="col-md-3 mb-3">
        <div class="card p-3">
          <h5 class="text-primary mb-3">ğŸ’¬ ì´ìš© í›„ê¸°</h5>
          <p class="text-muted">ë‹¤ë¥¸ ì‚¬ìš©ìë“¤ì˜ ë‚šì‹œ í›„ê¸°ì™€ ê²½í—˜ì„ í™•ì¸í•˜ì„¸ìš”.</p>
          <button class="btn btn-success w-100" onclick="goToReview()">ğŸ’¬ í›„ê¸° ë³´ê¸°</button>
        </div>
      </div>
    </div>
  </div>

  <!-- í•˜ë‹¨ í‘¸í„° -->
  <footer class="bg-dark text-white text-center py-3 mt-5">
    <p class="mb-1">ğŸ“§ Email: danakkafishing@naver.com</p>
    <small>&copy; 2025 ë‹¤ë‚šì•„ ë‚šì‹œ ì˜ˆì•½ ë„ìš°ë¯¸. All rights reserved.</small>
  </footer>

  <!-- JavaScript: ì˜ˆì•½ ì •ë³´ ê°€ì ¸ì˜¤ê¸° -->
  <script>
    function fetchReservations() {
      const date = document.getElementById("dateInput").value;
      if (!date) return alert("ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");

      fetch(`/api/reservations?date=${date}`)
        .then(res => res.json())
        .then(data => {
          let html = `
            <div class="card mt-3">
              <div class="card-header">ğŸš¤ ì˜ˆì•½ í˜„í™© (${date})</div>
              <div class="card-body p-0">
                <table class="table table-striped table-hover mb-0 w-100">
                  <thead class="table-dark">
                    <tr>
                      <th>ì§€ì—­</th><th>ì„ ë°•</th>
                      <th>ë¬¼ë•Œ</th><th>ì–´ì¢…</th><th>ë‚¨ì€ìë¦¬</th><th>ì˜ˆì•½</th>
                      <th>ì•Œë¦¼</th>
                    </tr>
                  </thead>
                  <tbody>`;

          if (data.length === 0) {
            html += `<tr><td colspan="7" class="text-center text-muted">í•´ë‹¹ ë‚ ì§œì— ì˜ˆì•½ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
          } else {
            data.forEach(row => {
              html += `<tr>
                <td>${row.zone}</td>
                <td>${row.ship_name}</td>
                <td>${row.wave_power}</td>
                <td>${row.fish_name}</td>
                <td>${row.reservation}</td>
                <td><a href="${row.booking_url}" target="_blank" class="btn btn-sm btn-success">ì´ë™</a></td>
                <td><button class="btn btn-sm btn-outline-danger" onclick="requestAlarm('${row.date}', '${row.zone}', '${row.ship_name}')">ğŸ””ìš”ì²­</button></td>
              </tr>`;
            });
          }

          html += `</tbody></table></div></div>`;
          document.getElementById("resultArea").innerHTML = html;
        })
        .catch(err => {
          console.error(err);
          document.getElementById("resultArea").innerHTML =
            `<div class="alert alert-danger">ê²€ìƒ‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</div>`;
        });    
    }

    function goToReview() {
      location.href = "/review";
    }

    function requestAlarm(date, zone, shipName) {
  // âœ… GMT í˜•ì‹ ë‚ ì§œë¥¼ YYYY-MM-DD í˜•ì‹ìœ¼ë¡œ ë³€í™˜
  if (date.includes("GMT")) {
    const dateObj = new Date(date);
    date = dateObj.toISOString().split('T')[0]; // YYYY-MM-DD í˜•ì‹ìœ¼ë¡œ ë³€í™˜
  }

  console.log("âœ… ìš”ì²­ í´ë¦­ë¨");
  console.log("âœ… ë‚ ì§œ:", date);
  console.log("âœ… ì§€ì—­:", zone);
  console.log("âœ… ì„ ë°•:", shipName);

  fetch('/alarm_request', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({ 
      date: date,
      zone: zone,
      ship_name: shipName 
    })
  })
  .then(response => response.json())
  .then(data => {
    console.log("âœ… ì„œë²„ ì‘ë‹µ:", data);
    if (data.success) {
      alert(data.message);
      window.location.reload();
    } else {
      alert(data.message);
    }
  })
  .catch(error => {
    console.error("âŒ ìš”ì²­ ì˜¤ë¥˜:", error);
    alert("ì•Œë¦¼ ë“±ë¡ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
  });
}

  </script>
</body>
</html>
